import sys
import couchdb
import configparser
import tweepy
from tweepy import OAuthHandler
import time

mydict = {u'Alpine': {'centre_coord': [146.97935432, -36.83412006499999],
  u'lga_code': 20110,
  'radius': 61.21351493029575},
 u'Ararat': {'centre_coord': [142.822438105, -37.48921653],
  u'lga_code': 20260,
  'radius': 56.488167002449444},
 u'Ballarat': {'centre_coord': [143.772873585, -37.518993185],
  u'lga_code': 20570,
  'radius': 26.942059881672698},
 u'Banyule': {'centre_coord': [145.08576626, -37.733855945],
  u'lga_code': 20660,
  'radius': 7.637226404465729},
 u'Bass Coast': {'centre_coord': [145.463289415, -38.486203305000004],
  u'lga_code': 20740,
  'radius': 37.68533071824894},
 u'Baw Baw': {'centre_coord': [146.14409407, -37.970026295],
  u'lga_code': 20830,
  'radius': 58.11777332989932},
 u'Bayside': {'centre_coord': [145.01764904, -37.939874125],
  u'lga_code': 20910,
  'radius': 7.100698811950838},
 u'Benalla': {'centre_coord': [146.02812194, -36.590407535],
  u'lga_code': 21010,
  'radius': 43.53035147978109},
 u'Boroondara': {'centre_coord': [145.053000635, -37.826466145],
  u'lga_code': 21110,
  'radius': 7.247743516490614},
 u'Brimbank': {'centre_coord': [144.816326935, -37.742865465],
  u'lga_code': 21180,
  'radius': 10.910902875962716},
 u'Buloke': {'centre_coord': [143.0517928, -35.846238255],
  u'lga_code': 21270,
  'radius': 86.15770156013961},
 u'Campaspe': {'centre_coord': [144.70843443, -36.32337539],
  u'lga_code': 21370,
  'radius': 63.16806216423848},
 u'Cardinia': {'centre_coord': [145.564521355, -38.0950452],
  u'lga_code': 21450,
  'radius': 31.665335461796747},
 u'Casey': {'centre_coord': [145.32274252000002, -38.09252443],
  u'lga_code': 21610,
  'radius': 19.211798602934127},
 u'Central Goldfields': {'centre_coord': [143.7401625, -36.9788681],
  u'lga_code': 21670,
  'radius': 37.708825382608886},
 u'Colac Otway': {'centre_coord': [143.5966086, -38.43859841],
  u'lga_code': 21750,
  'radius': 55.57853214961065},
 u'Corangamite': {'centre_coord': [143.23554423500002, -38.215959065],
  u'lga_code': 21830,
  'radius': 71.90812584845644},
 u'Darebin': {'centre_coord': [145.02287115500002, -37.738324965000004],
  u'lga_code': 21890,
  'radius': 6.9962027653547505},
 u'East Gippsland': {'centre_coord': [148.58266264, -37.34557173],
  u'lga_code': 22110,
  'radius': 147.12662426209118},
 u'Falls Creek Alpine Resort (Uninc)': {'centre_coord': [147.26440392,
   -36.860252955],
  u'lga_code': 0,
  'radius': 3.640556721919956},
 u'Frankston': {'centre_coord': [145.1687179, -38.134023760000005],
  u'lga_code': 22170,
  'radius': 9.641641337780289},
 u'French-Elizabeth-Sandstone Islands (Uninc)': {'centre_coord': [145.35580763000002,
   -38.350926470000005],
  u'lga_code': 0,
  'radius': 14.990139263369413},
 u'Gabo Island (Uninc)': {'centre_coord': [149.911406775, -37.55901835],
  u'lga_code': 0,
  'radius': 1.3454648517571122},
 u'Gannawarra': {'centre_coord': [143.853239925, -35.7320879],
  u'lga_code': 22250,
  'radius': 60.004396166484895},
 u'Glen Eira': {'centre_coord': [145.04102579, -37.89948881],
  u'lga_code': 22310,
  'radius': 5.840015910964275},
 u'Glenelg': {'centre_coord': [141.442373355, -37.89083924],
  u'lga_code': 22410,
  'radius': 73.23754506566954},
 u'Golden Plains': {'centre_coord': [143.86351958, -37.85225756],
  u'lga_code': 22490,
  'radius': 49.41636020946928},
 u'Greater Bendigo': {'centre_coord': [144.439731155, -36.722783115],
  u'lga_code': 22620,
  'radius': 52.53701881854456},
 u'Greater Dandenong': {'centre_coord': [145.190825595, -38.00113454],
  u'lga_code': 22670,
  'radius': 10.048936134731296},
 u'Greater Geelong': {'centre_coord': [144.46146209, -38.052151255],
  u'lga_code': 22750,
  'radius': 35.9251650858488},
 u'Greater Shepparton': {'centre_coord': [145.41520516999998, -36.42760637],
  u'lga_code': 22830,
  'radius': 45.7656550714441},
 u'Hepburn': {'centre_coord': [144.033544025, -37.31702664],
  u'lga_code': 22910,
  'radius': 38.89108875985402},
 u'Hindmarsh': {'centre_coord': [141.73282011999999, -36.03292977],
  u'lga_code': 22980,
  'radius': 74.72332010213616},
 u'Hobsons Bay': {'centre_coord': [144.8351498, -37.856947925],
  u'lga_code': 23110,
  'radius': 8.767367608460471},
 u'Horsham': {'centre_coord': [142.114477115, -36.82856761],
  u'lga_code': 23190,
  'radius': 59.81651758321811},
 u'Hume': {'centre_coord': [144.80512401, -37.59718717],
  u'lga_code': 23270,
  'radius': 19.86615878958228},
 u'Indigo': {'centre_coord': [146.68617025999998, -36.208395635],
  u'lga_code': 23350,
  'radius': 53.58359922576743},
 u'Kingston': {'centre_coord': [145.09532762499998, -38.004543525],
  u'lga_code': 23430,
  'radius': 10.418962701521725},
 u'Knox': {'centre_coord': [145.26923698000002, -37.8985046],
  u'lga_code': 23670,
  'radius': 10.006785697709145},
 u'Lake Mountain Alpine Resort (Uninc)': {'centre_coord': [145.861135575,
   -37.512010430000004],
  u'lga_code': 0,
  'radius': 3.08845558839598},
 u'Latrobe': {'centre_coord': [146.461312395, -38.253989704999995],
  u'lga_code': 23810,
  'radius': 38.25135180595322},
 u'Loddon': {'centre_coord': [143.829643675, -36.404105584999996],
  u'lga_code': 23940,
  'radius': 71.89559034323692},
 u'Macedon Ranges': {'centre_coord': [144.61571011, -37.333462170000004],
  u'lga_code': 24130,
  'radius': 37.46401271952261},
 u'Manningham': {'centre_coord': [145.18056473000001, -37.757085520000004],
  u'lga_code': 24210,
  'radius': 11.664984656268073},
 u'Mansfield': {'centre_coord': [146.147861515, -37.24129832],
  u'lga_code': 24250,
  'radius': 61.64716018847888},
 u'Maribyrnong': {'centre_coord': [144.87782908, -37.791389875],
  u'lga_code': 24330,
  'radius': 5.210478854582284},
 u'Maroondah': {'centre_coord': [145.26602767499998, -37.80288132],
  u'lga_code': 24410,
  'radius': 6.495644159431542},
 u'Melbourne': {'centre_coord': [144.944155945, -37.8130589],
  u'lga_code': 24600,
  'radius': 5.882955373660319},
 u'Melton': {'centre_coord': [144.62291326500002, -37.681419945],
  u'lga_code': 24650,
  'radius': 19.192641505228465},
 u'Mildura': {'centre_coord': [141.852432185, -34.864932835000005],
  u'lga_code': 24780,
  'radius': 127.13752130771667},
 u'Mitchell': {'centre_coord': [144.97997523499998, -37.175348845],
  u'lga_code': 24850,
  'radius': 54.823374376915694},
 u'Moira': {'centre_coord': [145.53782651, -36.050606470000005],
  u'lga_code': 24900,
  'radius': 69.24332025437756},
 u'Monash': {'centre_coord': [145.14716871000002, -37.896748915],
  u'lga_code': 24970,
  'radius': 8.010608325498067},
 u'Moonee Valley': {'centre_coord': [144.89325331, -37.749452774999995],
  u'lga_code': 25060,
  'radius': 6.091179277860944},
 u'Moorabool': {'centre_coord': [144.21944985, -37.633303865],
  u'lga_code': 25150,
  'radius': 39.15824953989879},
 u'Moreland': {'centre_coord': [144.93745374, -37.73553914],
  u'lga_code': 25250,
  'radius': 6.689336366786886},
 u'Mornington Peninsula': {'centre_coord': [144.95650768000002,
   -38.331261839999996],
  u'lga_code': 25340,
  'radius': 32.52596886385623},
 u'Mount Alexander': {'centre_coord': [144.187885365, -37.076019965],
  u'lga_code': 25430,
  'radius': 38.318479679786165},
 u'Mount Baw Baw Alpine Resort (Uninc)': {'centre_coord': [146.25558433,
   -37.844011285],
  u'lga_code': 0,
  'radius': 2.491735095236758},
 u'Mount Buller Alpine Resort (Uninc)': {'centre_coord': [146.444110635,
   -37.136786965],
  u'lga_code': 0,
  'radius': 5.302869423881998},
 u'Mount Hotham Alpine Resort (Uninc)': {'centre_coord': [147.129672635,
   -36.990281885],
  u'lga_code': 0,
  'radius': 7.047440949957174},
 u'Mount Stirling Alpine Resort (Uninc)': {'centre_coord': [146.46851367,
   -37.12561935],
  u'lga_code': 0,
  'radius': 7.055298803329719},
 u'Moyne': {'centre_coord': [142.46219288, -38.187844415],
  u'lga_code': 25490,
  'radius': 73.20306503496948},
 u'Murrindindi': {'centre_coord': [145.67436927, -37.281035419999995],
  u'lga_code': 25620,
  'radius': 59.087499457751974},
 u'Nillumbik': {'centre_coord': [145.21712531, -37.614766419999995],
  u'lga_code': 25710,
  'radius': 19.27828016519844},
 u'Northern Grampians': {'centre_coord': [142.872879715, -36.84961419],
  u'lga_code': 25810,
  'radius': 75.0893944395733},
 u'Port Phillip': {'centre_coord': [144.96149464, -37.858809425000004],
  u'lga_code': 25900,
  'radius': 5.646452783123716},
 u'Pyrenees': {'centre_coord': [143.364565965, -37.327574095],
  u'lga_code': 25990,
  'radius': 54.770211767012604},
 u'Queenscliffe': {'centre_coord': [144.65160994000001, -38.26500032],
  u'lga_code': 26080,
  'radius': 5.380804602159697},
 u'South Gippsland': {'centre_coord': [146.067019985, -38.69888535],
  u'lga_code': 26170,
  'radius': 62.902240895335765},
 u'Southern Grampians': {'centre_coord': [142.025285325, -37.53025029],
  u'lga_code': 26260,
  'radius': 71.72703647623842},
 u'Stonnington': {'centre_coord': [145.03776147500002, -37.861298715000004],
  u'lga_code': 26350,
  'radius': 5.9324358487534825},
 u'Strathbogie': {'centre_coord': [145.329376055, -36.7240159],
  u'lga_code': 26430,
  'radius': 58.74389204530868},
 u'Surf Coast': {'centre_coord': [144.11530624, -38.339941385],
  u'lga_code': 26490,
  'radius': 36.72024665722295},
 u'Swan Hill': {'centre_coord': [143.16883817000001, -35.10056788],
  u'lga_code': 26610,
  'radius': 85.23819260754316},
 u'Towong': {'centre_coord': [147.62602309, -36.37052706],
  u'lga_code': 26670,
  'radius': 72.29666566719065},
 u'Wangaratta': {'centre_coord': [146.428384505, -36.616378600000004],
  u'lga_code': 26700,
  'radius': 66.26065864586229},
 u'Warrnambool': {'centre_coord': [142.52163619499999, -38.378226260000005],
  u'lga_code': 26730,
  'radius': 11.775925787088996},
 u'Wellington': {'centre_coord': [147.01697257, -37.95568703],
  u'lga_code': 26810,
  'radius': 111.36991578660248},
 u'West Wimmera': {'centre_coord': [141.40038907000002, -36.599198869999995],
  u'lga_code': 26890,
  'radius': 102.18309160333658},
 u'Whitehorse': {'centre_coord': [145.154318495, -37.82867539],
  u'lga_code': 26980,
  'radius': 6.593398208576012},
 u'Whittlesea': {'centre_coord': [145.0937519, -37.550866465],
  u'lga_code': 27070,
  'radius': 21.038938472633372},
 u'Wodonga': {'centre_coord': [146.88037251, -36.144697120000004],
  u'lga_code': 27170,
  'radius': 21.58306579498709},
 u'Wyndham': {'centre_coord': [144.63578245500003, -37.89369927],
  u'lga_code': 27260,
  'radius': 20.952371072358236},
 u'Yarra': {'centre_coord': [145.003369945, -37.804935905],
  u'lga_code': 27350,
  'radius': 4.933175180251163},
 u'Yarra Ranges': {'centre_coord': [145.73709516999998, -37.750100755],
  u'lga_code': 27450,
  'radius': 47.13442368352015},
 u'Yarriambiack': {'centre_coord': [142.40448727, -36.02615376],
  u'lga_code': 27630,
  'radius': 89.64829929894012}}

config = configparser.ConfigParser()
config.read('config.ini')

auth = OAuthHandler(config['Harvest']['ConsumerKey'], config['Harvest']['ConsumerSecret'])
auth.set_access_token(config['Harvest']['AccessToken'], config['Harvest']['AccesTokenSecret'])
api = tweepy.API(auth)
couch = couchdb.Server( config['Harvest']['DatabaseIP'])
locationdatabase = config['LocationSearch']['DatabaseCrawl']

if locationdatabase not in couch:
    locationdb = couch.create(locationdatabase)
else:
    locationdb = couch[locationdatabase]

new = 0
old = 0
for k,v in mydict.items():
    try:
        location_list = api.reverse_geocode(long=str(v['centre_coord'][0]), 
            lat=str(v['centre_coord'][1]), accuracy=v['radius']/1000)
    except tweepy.error.RateLimitError:
        time.sleep(1000)

    print(len(location_list))
    for loc in location_list:
        try:
            location = {}
            location['_id'] = loc.id
            locationdb.save(location)
            new += 1
        except couchdb.http.ResourceConflict:
            old += 1
            pass

print('new', new)
print('old', old)